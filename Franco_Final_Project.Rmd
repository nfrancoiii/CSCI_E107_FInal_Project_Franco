---
title: "Measuringthe Cost Savings and Environmental Benefits of Operating an Electric Vehicle"
author: "Nicholas Franco III"
date: "May 4, 2016"
output: html_document
---

```{r Libraries, echo=FALSE, message=FALSE}
# Load Libraries
  library(dplyr)
  library(tidyr)
  library(ggplot2)
  library(xlsx)
  library(readr)
  library(reshape)
  library(rvest)
  library(stringr)
```


# Overview and Motivation

<em>"The time is right for electric cars - in fact the time is critial."</em> - Carlos Ghosn

Everyday global warming is becoming a more imposing threat. The greenhouse effect caused by the release of carbon dioxide from the process of burning fossil fuels has become perhaps the single greatest challenge humanity has faced. In order to slow and reverse the negative effects of global warming, we need to aggresively persue technologies and products that will eliminate or greatly reduce the amouont of fossil fuel burned and as a result the amount of CO2 added to the atmosphere. The transportation sector accounted for roughly 26 percent of the greenhouse gas emissions in the U.S. in 2014, the second largest contributing sector.<sup>1</sup> Electric cars provide a great opportunity to help reduce and eventually eliminate the greenhouse gas contributions of over a quarter of the total U.S. greenhouse gas emission sources.

The catch, of course, is that eliminating the need to burn fossil fuels in the transportation sector shifts the energy burden to the electricity sector, the largest constributing sector to greenhouse gas emissions in the U.S. comprising 30 percent of all emissions.<sup>1</sup> This fact has served as fodder for some to criticize the greenhouse gas reducing possibilities of electric vehicles. <em>"Electric cars are coal-powered cars. Their carbon emissions can be worse than gasoline powered cars."</em> -Vinod Khosla. To say that electric vehicles are completely emission-free is, in most case, incorrect, or at least doesn't consider the full story. And this quote about the emissions from electric cars being worse than gasoline cars may certainly be true in some cases. In this analysis I will explore this claim and show under what conditions it may prove true. 

The 2015 Paris Agreement called for an aggressive reduction in global carbon emissions and two of the sectors most responsible for emitting CO2 are the electricity and transportation sectors. It is important to understand that while electric cars can do a great deal with respect to reducing carbon emissions in the transportation sector, the net impact is not as simple. While our electricity system is still reliant on fossil fuels, any emissions impact from the transition to electric vehicles will be mitigated by the fact that additional electricity will need to be generated to charge those batteries.

### Personal Motivation

Standing in line for the Tesla Model 3 last month, I became one of the over 300,000 people to reserve the company's first "mass-market" long range electric vehicles in the first week of reservations. As electric cars prepare to play a larger role in the market, it is important to understand how commodity prices and the electricity system in the US will interact with the demand for and viability of electric vehicles. 

I have worked professionally in energy and electricity market consulting for the past five years and have developed an understanding of how the various pieces of the electricity system fit together. This experience will help me contextualize my data and analysis. In addition to my professional work, I am environmentally conscious and passionate about technology and "green innovations". I hope that through this analysis I will present information that will encourage others to make the switch from traditional gasoline engine vehicles to electric vehicles.

### Overview of This Analysis

This analysis will explore two key concepts surrounding the discussion of electric vehicles in comparison with traditional internal combustion engine (ICE) vehicles. The first concept I will explore is relative cost to operate. At this point, the sticker price for electric vehicles tends to be higher on average than their most comparable ICE vehicle counterpart. This upfront cost comparison, however, ignores the costs of operating the car, which as I will see skews sharply in favor of electric vehicles. I can create such a comparison by evaluating the average cost to drive each type of vehicle a mile.

The second concept I will explore is the CO2 emissions per mile of both types of vehicle. While we often think the answer to this is obvious that EVs do not emit any CO2, the reality is that there are CO2 emissions related to the production of the electricity used to charge the batteries in these vehicles. I will show how the CO2 intensity of various types of electricity generating units (EGUs) compare to the tailpipe emissions of traditional ICE vehicles.

# Related Work

Electric car sales in the United States and globally have begun to take off as companies like Tesla have made great strides in removing the two largest barriers to EV ownership: range and infrastructure. Electric cars are now approaching 300 miles of range on a single charge and the industry expects advancements over the next decade may make electric vehicles more appealing that gasoline cars.  Additionally, private companies have taken on expanding the network of electric charging stations. As such, we have seen the number of EV sales ramp up with no signs of slowing as can be seen in the bar chart below.

```{r U.S. Electric Car Sales}

  # U.S. Electric Car Sales
    temp <- tempfile()
    download.file("http://www.afdc.energy.gov/uploads/data/data_source/10567/10567_pev_sales.xlsx", temp, mode="wb")
    ev_sales <- read.xlsx("10567_pev_sales.xlsx", sheetIndex=1, startRow = 3)
    
    # Clean Data
    names(ev_sales)[1] <- "Model"
    ev_sales <- melt(ev_sales, id=c("Model", "Type")) %>%
      filter(value > 0) %>%
      filter(Model != "Total") %>%
      filter(variable != "TOTAL")
      ev_sales$variable <- gsub("X", "", as.character(ev_sales$variable))
      ev_sales$variable <- as.numeric(ev_sales$variable)
    names(ev_sales)[3] <- "Year"
    names(ev_sales)[4] <- "Sales"

    # Stacked Bar Chart
    ev_sales %>%
      ggplot(aes(x=Year, y=Sales, fill=Model)) +
      geom_bar(stat="identity") +
      ggtitle("US EV Sales")
```

With the EV market's rapid rise, many articles have been popping up to attempt to compare the costs of electric vehicles and traditional ICE vehicles. One such example from dailyfinance.com explored the full cost of comparable cars and considered the "at the pump" cost for each.<sup>2</sup>

Similarly, many skeptics have been quick to point out that EV's need to get their energy from somewhere and in some cases, the emissions from producing that electricity produces more CO2 than a gasoline car would at the tailpipe. 

The central limitation of these earlier studies and comparisons is that they rely on data and information that is slightly older. As we saw in the chart above, the electric vehicle market has grown in leaps and bounds in the last five years including technological improvements and advancements in battery efficiency.  The electricity sector has changed too with greater reliance on natural gas power facilities and a declining reliance on coal-fired power plants.  All of these factors will affect the cost-effectiveness and environmental benefits of electric vehicles. This analysis will rely on the most up to date information publicly available. 

# Initial Questions

# Data

This section will discuss the sources of data used for this analysis as well as the methods used for wrangling and preparing the data for the analysis. In addition to the data details described, explanations for specific methodologies will be provided through out the analysis to clarify decisions and processes as necessary. 

### Sources

In an effort to make this analysis as reproducible as possible, all sources of data used here are publicly available. 

Throughout the analysis, we rely heavily on the website FuelEconomy.gov, which is the official U.S. government source for fuel economy information. This website is provided under the U.S. Department of Energy.  Specifically we rely on the information provided in the "Vehicle" data set which contains information for 1984-current model year vehicles. This data set contains information central to the analysis such as the efficiency of all vehicles, as measured in miles per gallon (mpg) for internal combustion engine vehicles (ICE) and in killowatthours per 100 miles for electric vehicles. This data set also contains information on the amount of carbon dioxide emitted at the tailpipe for ICE vehicles.

In addition to the U.S. DOE vehicles data set, we rely on the U.S. Energy Information Administration for data on average annual U.S. retail electricity prices and the carbon dioxide intensity of various electricity generating unit fuel types. This information is used to calculate the carbon dioxide equivalent emissions of driving an electric vehicle. 
Unfortunately, some data that would be quite interesting, useful and relevant for this analysis is not publicly available. For example, data and statistics on car sales by make and model are generally not available publicly and only for purchase. In the spirit of performing a reproducible analysis, it seems appropriate to exclude such data source even though it precludes me from performing certain analyses that I had hoped to perform and mentioned in my project proposal; notably, the regression analysis. I will instead discuss this issue conceptually in the "XXXXXX" section. 

### Methods

Throughout my data collection, I encountered data of interest in a variety of formats. This fact required a variety of data wrangling methodologies. In order to provide a readable and complete methodology for gathering my data, I made every effort to codify my data collection. 

In the case of my main data set, the "vehicles" data from the U.S. DOE, the data is available for download as a zipped comma-separated values file. For this case, I was able to directly download the zipped data file into a temporary file, unzip the file and read the file in as a table using the `readr` library.

The data from the U.S. EIA that provided values for the carbon dioxide intensity of the various electric generating unit fuel types was contained in an html table on the website of the EIA. I used a web scraping technique to pull the table directly into my R work space by finding the xpath of the data table in the html code and using the `rvest` library to read in the table. 

**XXXXX**
Some of the data from the EIA was available as downloadable Microsoft excel files. The data sources in this form included the average annual historical U.S. retail electricity prices and the average annual historical U.S. gasoline prices. In most cases, these excel files did not not begin in the first column and row. Instead, I needed to specify what row was the "startRow" using the functionality provided in the `xlsx` library. I then used the `dplyr` library to clean the data down to what was most important and remove any `NA` columns that had been read in.

# Exploratory Analysis


```{r Exploratory Analysis}
# Open and Unzip Data From U.S. Department of Energy
temp <- tempfile()
download.file("http://www.fueleconomy.gov/feg/epadata/vehicles.csv.zip", temp, mode="wb")
unzip(temp, "vehicles.csv")
vehicles <- read.table("vehicles.csv", sep=",", header=T)

download.file("http://www.fueleconomy.gov/feg/epadata/emissions.csv.zip", temp, mode="wb")
unzip(temp, "emissions.csv")
emissions <- read.table("emissions.csv", sep=",", header=T)

# Merge Vehicle and Emission Data Sets
merged <- vehicles %>%
  left_join(emissions, by = "id")

# Download EV Data
download.file("http://www.afdc.energy.gov/uploads/data/data_source/10567/10567_pev_sales.xlsx", temp, mode="wb")
test <- read.xlsx("10567_pev_sales.xlsx", sheetIndex=1, startRow = 3)

# Explore Vehicles

vehicles %>%
  ggplot(aes(year, UCity)) +
  geom_point() +
  geom_smooth()
  
# Download Electricity Price Data
  #state_elec_price_historical <- read_csv("Average_retail_price_of_electricity.csv", skip=5)
  #names(state_elec_price_historical)[1] <- "State"
  #state_elec_price_historical <- melt(state_elec_price_historical, id = "State")


us_elec_price_historical <- read_csv("Average_retail_price_of_electricity_annual.csv", skip=4)
names(us_elec_price_historical)[2] <- "centsPerKWh"

# Download Gasoline Price Data
us_gas_price_historical <- read.xlsx("fotw#915_web.xlsx", sheetIndex = 1, startRow = 7)
us_gas_price_historical <- us_gas_price_historical %>%
  select(Year, Retail.Gasoline.Price...Current.dollars.gallon.) %>%
  filter(Retail.Gasoline.Price...Current.dollars.gallon. > 0)
  names(us_gas_price_historical) <- c("Year", "Price")
  

```

### Emissions Per Mile
```{r Emissions Per Mile}

vehicles %>%
  ggplot(aes(year, co2A)) +
  geom_point() +
  geom_smooth()

```

## Cost Per Mile Driven

One way to compare the cost benefits of electric vehicles against ICE vehicles is by estimating the cost to drive a mile in each. For this, we rely on data from the U.S. Department of Energy and their fuel economy data set. This data set provides us with the efficiency of cars in terms of miles per gallon (mpg) for ICE vehicles and killowatthours (kWh) per 100 miles driven. For estimates of costs of the fuels for each, we need a monetary value for a gallon of gasoline as well as for the cost of a kWh of electricity. We rely on the U.S. Department of Energy Vehicle Technology Office for average historical prices of gasoline in the United States.  For estimates of average historical prices of electricity in the United States, we use data from the U.S. Energy Information Administration (EIA).

### Internal Combustion Cost Per Mile

In order to calculate the cost per mile for ICE vehicles we will need to use information on vehicle efficiency as measured by mpg and the cost of the inputs, gasoline in this case. Our formula will then be: $$\frac{\frac{$}{gallon}}{\frac{miles}{gallon}}$$

The above equation become: $$\frac{$}{gallon} x \frac{gallon}{miles} = \frac{$}{miles}$$

```{r ICE Cost Per Mile, warning=FALSE}

## Internal Combustion Engines

  # Dollars Per Gallon ($/gal)
  dol_gal <- as.data.frame(us_gas_price_historical)
  dol_gal$Year <- as.numeric(levels(dol_gal$Year)[dol_gal$Year])
  
  dol_gal %>%
    filter(Year >= 1980) %>%
    ggplot(aes(Year, Price)) +
    geom_line(color="brown") +
    ylab("Dollars per Gallon") +
    ggtitle("U.S. Average Historical Price per Gallon of Gasoline")
  
```

The chart above shows that gasoline prices were relatively low through the 1980s and 90s and began to climb in the early 2000s until peaking in 2012. Since 2012 prices have been on a decline.

```{r}
  # Miles Per Gallon (MPG)
    mpg <- vehicles %>%
    filter(combE == 0)
  
  mpg %>%
    ggplot(aes(year, comb08)) +
    geom_point() +
    geom_smooth(color="brown") +
    xlab("Year") +
    ylab("Miles per Gallon") +
    ggtitle("Miles per Gallon of All Models")

```  

We can see that efficiency for all ICE vehicles has increased slightly over the most recent 5 years or so.

```{r Dollars per Mile ICE, warning=FALSE}
  # Dollars per Mile
  ice_merged <- mpg %>%
    left_join(dol_gal, by=c("year" = "Year")) %>%
    mutate(CentsPerMile = Price*100/comb08)
  
  ice_merged %>%
    ggplot(aes(year, CentsPerMile)) +
    geom_point() +
    geom_smooth(color="brown") + 
    xlab("Year") +
    ylab("Cents per Mile") +
    ggtitle("Internal Combustion Engine Cost per Mile (Cents per Mile)")
  
```

We can see in the chart 

### Electric Vehicles Cost Per 100 Miles



```{r Electric Vehciles, warning=FALSE}
## Electric Vehicles
  
  # Dollars Per Killowatthour ($/kwh)
  dol_kwh <- us_elec_price_historical

  # Augment Data for 2016
  price_2016 <- us_elec_price_historical %>%
  filter(Year >= 2014) %>%
  summarise(centsPerKWh =mean(centsPerKWh))

  dat_2016 <- as.data.frame(c(2016, price_2016))
    names(dat_2016) <- names(dol_kwh)

  dol_kwh <- us_elec_price_historical %>%
  rbind(dat_2016)
  
  dol_kwh %>%
    ggplot(aes(Year, centsPerKWh)) +
    geom_line(color="blue") +
    ylab("Cents per kWh") +
    ggtitle("Average Annual U.S. Electricity Prices")

```



```{r, warning=FALSE}

  #  Killowatthour/100 miles (kwh/100m)
  kwh_100m <- vehicles %>%
    filter(combE > 0)
  
  kwh_100m %>%
    ggplot(aes(year, combE)) +
    geom_point() +
    geom_smooth() +
    xlab("Year") +
    ylab("kWh per 100 Miles") +
    ggtitle("Electric Vehicle Killowatthours per 100 Miles")
  
  # Dollars per mile
  elec_merged <- kwh_100m %>%
    left_join(dol_kwh, by=c("year" = "Year")) %>%
    mutate(centsPerMile = (combE/100)*centsPerKWh)
  
  elec_merged %>%
    ggplot(aes(year, centsPerMile)) +
    geom_point() +
    geom_smooth() + 
    xlab("Year") +
    ylab("Cents Per Mile") +
    ggtitle("Cost per Mile for Electric Vehicles")
  
```

### Electric v. ICE Cost per Mile

```{r Electric v ICE, warning=FALSE}
  
  ggplot() +
    geom_smooth(aes(elec_merged$year, elec_merged$centsPerMile, color="Electric")) +
    geom_smooth(aes(ice_merged$year,ice_merged$CentsPerMile, color="ICE")) +
    scale_color_manual("",
                       breaks = c("Electric", "ICE"),
                       values = c("blue", "brown")) +
    xlab("Year") +
    ylab("Cents per Mile") +
    ggtitle("Comparison of Electric and ICE Cars by Cost per Mile")
    
```


Now, the fleet of electric car options available is not as wide as those for ICE vehicles. We will limit out data set in two ways; one where we include only the vehicle classes where there is an EV option and another where we include only the vehicle classes for which there are more than 10 EV options.

```{r Subset of ICE Cars, warning=FALSE}
  
  # Create Unique List of VClasses for EVs
  elec_type <- elec_merged %>%
    select(VClass) %>%
    group_by(VClass) %>%
    summarize(Count = n())
  elec_type
  trim_elec_type <- elec_type %>%
    filter(Count > 10)
  trim_elec_type
  
  elec_merged_trim <- elec_merged %>%
    filter(VClass %in% trim_elec_type$VClass)
  
  # Trim the ICE data to only include comparable cars
  ice_comparable <- ice_merged %>%
    filter(VClass %in% elec_type$VClass)
  
  ice_comparable_trim <- ice_merged %>%
    filter(VClass %in% trim_elec_type$VClass)

  # Cost per Mile for Groups of ICE Vehicles
  ggplot() +
    geom_smooth(aes(ice_merged$year, ice_merged$CentsPerMile, color="All Classes")) +
    geom_smooth(aes(ice_comparable$year, ice_comparable$CentsPerMile, color="Classes with EV Option")) +
    geom_smooth(aes(ice_comparable_trim$year, ice_comparable_trim$CentsPerMile, color="Classes with > 10 EV Options")) +
  scale_color_manual("",
                     breaks = c("All Classes", "Classes with EV Option", "Classes with > 10 EV Options"),
                     values = c("brown", "blue", "black")) +
    ylab("Year") +
    xlab("Cents per Mile") +
    ggtitle("Cost per Mile for Groups of ICE Vehicles")
    
    
  # Comparison of Electric and ICE Cars by Cost per Mile (Assuming Same Vehicle Class)
  ggplot() +
    geom_smooth(aes(elec_merged_trim$year, elec_merged_trim$centsPerMile, color="Electric")) +
    geom_smooth(aes(ice_comparable_trim$year,ice_comparable_trim$CentsPerMile, color="ICE")) +
    scale_color_manual("",
                       breaks = c("Electric", "ICE"),
                       values = c("blue", "black")) +
    xlab("Year") +
    ylab("Cents per Mile") +
    ggtitle("Comparison of Electric and ICE Cars by Cost per Mile Comparing Same Vehicle Classes")
 
```

Even when we directly compare vehicle classes, electric vehicles are less costly to operate per mile driven, especially in the period of high gasoline prices as was seen through out the first decade of the century. 

## Emissions Comparison

Global warming is caused by increased greenhouse gases that allow heat from the sun to permeate to earth, but prevent that heat from escaping when reflected off the earth's surface. Atmospheric greenhouse gases have increased at alarming rates since the industrial revolution and the scientific community has concluded that we need to drastically cut back on burning fossil fuels; a process which releases carbon dioxide (CO2) a greenhouse gas.

While it may seem obvious that an ICE vehicle emits more CO2 than an electric vehicle, it is a bit more complicated. Since the electricity produced to "fuel" electric vehicles does not always come from renewable sources, there are indeed CO2 emissions related to operating an electric vehicle. In this section, we will compare the tailpipe emissions of CO2 per mile of comparable ICE vehicles and CO2 emissions related to producing the energy required to move an electric vehicle a mile.

### ICE Vehicle Tailpipe Emissions

There are emissions directly related to the operation of ICE vehicles in that when gasoline is burned to fuel the engine, CO2 is released from the tailpipe. Our data set from the U.S. Department of Energy provides information on tailpipe emissions in grams of CO2 per mile.

```{r ICE CO2 per Mile}
  
  # ICE CO2 per mile
  ice_comparable_trim %>%
    ggplot(aes(year, co2TailpipeGpm)) +
    geom_point() +
    geom_smooth(color="brown") +
    xlab("Year") +
    ylab("Grams per Mile") +
    ggtitle("CO2 per Mile for Comparable Class ICE Vehicles")
    
```

We can see in the chart above that comparable ICE vehicles have remained fairly steady in their emissions per mile driven over the last thirty years. However, we have seem that in the last five years a slight improvement in tailpipe emissions.

### EV Tailpipe Emissions

Electric vehicles produce no CO2 at the tailpipe. EVs, in fact, do not even have tailpipes. However, CO2 is generally burned in order to create the electricity used to charge the battery in an EV. 

```{r EV CO2 per Mile}
  
  # Scrap EIA Table for CO2 per kWh
  
  url <- "https://www.eia.gov/tools/faqs/faq.cfm?id=74&t=11"
  co2_kwh <- url %>% read_html() %>% html_node(xpath ='//*[@id="innerX"]/div/div[3]/div[1]/table') %>% html_table()
  co2_kwh <- co2_kwh %>%
    filter(Fuel != "Coal")
  co2_kwh$Fuel <- str_trim(as.character(co2_kwh$Fuel), "l")
  
  # kWh per Mile
  elec_merged_trim <- elec_merged_trim %>%
    mutate(kwh_m = combE / 100)
  
  # Combine EV data with CO2 per kWh and convert to grams
  
  grams_per_lb <- 453.593 ## Source: Google
  
  elec_merged_trim <- elec_merged_trim %>%
    mutate(bit_co2_m = kwh_m*co2_kwh$`Pounds of CO2 per kWh`[1]*grams_per_lb,
           subbit_co2_m = kwh_m*co2_kwh$`Pounds of CO2 per kWh`[2]*grams_per_lb,
           lig_co2_m = kwh_m*co2_kwh$`Pounds of CO2 per kWh`[3]*grams_per_lb,
           ng_co2_m = kwh_m*co2_kwh$`Pounds of CO2 per kWh`[4]*grams_per_lb,
           fo2_co2_m = kwh_m*co2_kwh$`Pounds of CO2 per kWh`[5]*grams_per_lb,
           fo6_co2_m = kwh_m*co2_kwh$`Pounds of CO2 per kWh`[6]*grams_per_lb)
  
  # Graph CO2 per Mile for EVs for each 
  elec_merged_trim %>%
    ggplot(aes(x=year)) +
    geom_smooth(aes(y=bit_co2_m, color="Bituminous")) +
    geom_smooth(aes(y=subbit_co2_m, color="Subbituminous")) +
    geom_smooth(aes(y=lig_co2_m, color="Lignite")) +
    geom_smooth(aes(y=ng_co2_m, color="Natural Gas")) +
    geom_smooth(aes(y=fo2_co2_m, color="Fuel Oil No. 2")) +
    geom_smooth(aes(y=fo6_co2_m, color="Fuel Oil No. 6")) +
    scale_color_manual("", 
                       breaks = c("Bituminous", "Subbituminous", "Lignite", "Natural Gas", "Fuel Oil No. 2", "Fuel Oil No. 6"),
                       values = c("brown", "darkgreen", "black", "red", "blue", "orange")) +
    ylab("Grams Per Mile") +
    xlab("Year") +
    ggtitle("CO2 per Mile for EVs by Electricity Source")
```

## Compare CO2 Per Mile of ICE and EVs

```{r Comparison of CO2 per Mile}

  # Comparison of CO2 per Mile
  ggplot()+
    geom_smooth(aes(x=ice_comparable_trim$year, y=ice_comparable_trim$co2TailpipeGpm, color="ICE Vehicles")) +
    geom_smooth(aes(x=elec_merged_trim$year, y=elec_merged_trim$bit_co2_m, color="EV (Bituminous)")) +
    geom_smooth(aes(x=elec_merged_trim$year, y=elec_merged_trim$fo2_co2_m, color="EV (FO2)")) +
    geom_smooth(aes(x=elec_merged_trim$year, y=elec_merged_trim$ng_co2_m, color="EV (NG)")) +
    scale_color_manual("",
                       breaks = c("ICE Vehicles", "EV (Bituminous)", "EV (FO2)", "EV (NG)"),
                       values = c("brown", "orange", "black", "blue")) +
    xlab("Year") +
    ylab("Grams per Mile") +
    ggtitle("Comparison of CO2 Emissions per Mile Over Time")
  
```


# Final Analysis

# Sources

<sup>1</sup> U.S. Environmental Protection Agency (EPA). 2014. Inventory of U.S. Greenhouse Gases and Sinks. https://www3.epa.gov/climatechange/ghgemissions/usinventoryreport.html. Accessed on May 2, 2016.

<sup>2</sup> DailyFinance. 2013. Pump vs. Plug: Do You Really Save Money Driving an Electric Car? http://www.dailyfinance.com/2013/06/24/gas-vs-electric-cars-cost-comparison/

