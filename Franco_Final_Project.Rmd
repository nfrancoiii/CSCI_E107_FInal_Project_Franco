---
title: "Final_Project_Franco"
author: "Nicholas Franco III"
date: "April 16, 2016"
output: html_document
---

# Overview and Motivation


Standing in line for the Tesla Model 3 last month, I became one of the over 300,000 people to reserve the company's first "mass-market" long range electric vehicles in the first week of reservations. As electric cars prepare to play a larger role in the market, it is important to understand how commodity prices and the electricity system in the US will interact with the demand for and viability of electric vehicles. 

I have worked professionally in energy and electricity market consulting for the past five years and have developed an understanding of how the various pieces of the electricity system fit together. This experience will help me contextualize my data and analysis. In addition to my professional work, I am environmentally conscious and passionate about technology and "green innovations".

The 2015 Paris Agreement called for an aggressive reduction in global carbon emissions and two of the sectors most responsible for emitting CO2 are the electricity and transportation sectors. It is important to understand that while electric cars can do a great deal with respect to reducing carbon emissions in the transportation sector, the net impact is not as simple. While our electricity system is still reliant on fossil fuels, any emissions impact from the transition to electric vehicles will be mitigated by the fact that additional electricity will need to be generated to charge those batteries.

# Related Work

# Initial Questions

# Data

The data sources for this project include the 
# Exploratory Analysis
```{r Libraries, echo=FALSE, message=FALSE}

library(dplyr)
library(tidyr)
library(ggplot2)
library(xlsx)
library(readr)
library(reshape)
library(rvest)
library(stringr)
```


```{r Exploratory Analysis}
# Open and Unzip Data From U.S. Department of Energy
temp <- tempfile()
download.file("http://www.fueleconomy.gov/feg/epadata/vehicles.csv.zip", temp, mode="wb")
unzip(temp, "vehicles.csv")
vehicles <- read.table("vehicles.csv", sep=",", header=T)

download.file("http://www.fueleconomy.gov/feg/epadata/emissions.csv.zip", temp, mode="wb")
unzip(temp, "emissions.csv")
emissions <- read.table("emissions.csv", sep=",", header=T)

# Merge Vehicle and Emission Data Sets
merged <- vehicles %>%
  left_join(emissions, by = "id")

# Download EV Data
download.file("http://www.afdc.energy.gov/uploads/data/data_source/10567/10567_pev_sales.xlsx", temp, mode="wb")
test <- read.xlsx("10567_pev_sales.xlsx", sheetIndex=1, startRow = 3)

# Explore Vehicles

vehicles %>%
  ggplot(aes(year, UCity)) +
  geom_point() +
  geom_smooth()
  
# Download Electricity Price Data
  #state_elec_price_historical <- read_csv("Average_retail_price_of_electricity.csv", skip=5)
  #names(state_elec_price_historical)[1] <- "State"
  #state_elec_price_historical <- melt(state_elec_price_historical, id = "State")


us_elec_price_historical <- read_csv("Average_retail_price_of_electricity_annual.csv", skip=4)
names(us_elec_price_historical)[2] <- "centsPerKWh"

# Download Gasoline Price Data
us_gas_price_historical <- read.xlsx("fotw#915_web.xlsx", sheetIndex = 1, startRow = 7)
us_gas_price_historical <- us_gas_price_historical %>%
  select(Year, Retail.Gasoline.Price...Current.dollars.gallon.) %>%
  filter(Retail.Gasoline.Price...Current.dollars.gallon. > 0)
  names(us_gas_price_historical) <- c("Year", "Price")
  

```

### Emissions Per Mile
```{r Emissions Per Mile}

vehicles %>%
  ggplot(aes(year, co2A)) +
  geom_point() +
  geom_smooth()

```

## Cost Per Mile Driven

One way to compare the cost benefits of electric vehicles against ICE vehicles is by estimating the cost to drive a mile in each. For this, we rely on data from the U.S. Department of Energy and their fuel economy data set. This data set provides us with the efficiency of cars in terms of miles per gallon (mpg) for ICE vehicles and killowatthours (kwh) per 100 miles driven. For estimates of costs of the fuels for each, we need a monetary value for a gallon of gasline as well as for the cost of a kwh of electricity. We rely on the U.S. Department of Energy Vehicle Technology Office for average historical prices of gasoline in the United States.  For estimates of average historical prices of electricity in the United States, we use data from the U.S. Energy Information Administration (EIA).

### Internal Combustion Cost Per Mile

In order to calculate the cost per mile for ICE vehicles we will need to use information on vehicle efficiency as measured by mpg and the cost of the inputs, gasoline in this case. Our formula will then be: $$\frac{\frac{$}{gallon}}{\frac{miles}{gallon}}$$

The above equation become: $$\frac{$}{gallon} x \frac{gallon}{miles} = \frac{$}{miles}$$

```{r ICE Cost Per Mile, warning=FALSE}

## Internal Combustion Engines

  # Dollars Per Gallon ($/gal)
  dol_gal <- as.data.frame(us_gas_price_historical)
  dol_gal$Year <- as.numeric(levels(dol_gal$Year)[dol_gal$Year])
  
  dol_gal %>%
    filter(Year >= 1980) %>%
    ggplot(aes(Year, Price)) +
    geom_line(color="brown") +
    ylab("Dollars per Gallon") +
    ggtitle("U.S. Average Historical Price per Gallon of Gasoline")
  
```

The chart above shows that gasoline prices were relatively low through the 1980s and 90s and began to climb in the early 2000s until peaking in 2012. Since 2012 prices have been on a decline.

```{r}
  # Miles Per Gallon (MPG)
    mpg <- vehicles %>%
    filter(combE == 0)
  
  mpg %>%
    ggplot(aes(year, comb08)) +
    geom_point() +
    geom_smooth(color="brown") +
    xlab("Year") +
    ylab("Miles per Gallon") +
    ggtitle("Miles per Gallon of All Models")

```  

We can see that efficiency for all ICE vehciles has increased slightly over the most recent 5 years or so.

```{r}
  # Dollars per Mile
  ice_merged <- mpg %>%
    left_join(dol_gal, by=c("year" = "Year")) %>%
    mutate(CentsPerMile = Price*100/comb08)
  
  ice_merged %>%
    ggplot(aes(year, CentsPerMile)) +
    geom_point() +
    geom_smooth(color="brown") + 
    xlab("Year") +
    ylab("Cents per Mile") +
    ggtitle("Internal Combustion Engine Cost per Mile (Cents per Mile)")
  
```

We can see in the chart 

### Electric Vehicles Cost Per 100 Miles



```{r Electric Vehciles, warning=FALSE}
## Electric Vehicles
  
  # Dollars Per Killowatthour ($/kwh)
  dol_kwh <- us_elec_price_historical

  # Augment Data for 2016
  price_2016 <- us_elec_price_historical %>%
  filter(Year >= 2014) %>%
  summarise(centsPerKWh =mean(centsPerKWh))

  dat_2016 <- as.data.frame(c(2016, price_2016))
    names(dat_2016) <- names(dol_kwh)

  dol_kwh <- us_elec_price_historical %>%
  rbind(dat_2016)
  
  dol_kwh %>%
    ggplot(aes(Year, centsPerKWh)) +
    geom_line() +
    ylab("Cents per kWh") +
    ggtitle("Average Annual U.S. Electricity Prices")

```



```{r}

  #  Killowatthour/100 miles (kwh/100m)
  kwh_100m <- vehicles %>%
    filter(combE > 0)
  
  kwh_100m %>%
    ggplot(aes(year, combE)) +
    geom_point() +
    geom_smooth() +
    xlab("Year") +
    ylab("kWh per 100 Miles") +
    ggtitle("Electric Vehicle Killowatthours per 100 Miles")
  
  # Dollars per mile
  elec_merged <- kwh_100m %>%
    left_join(dol_kwh, by=c("year" = "Year")) %>%
    mutate(centsPerMile = (combE/100)*centsPerKWh)
  
  elec_merged %>%
    ggplot(aes(year, centsPerMile)) +
    geom_point() +
    geom_smooth() + 
    xlab("Year") +
    ylab("Cents Per Mile") +
    ggtitle("Cost per Mile for Electric Vehicles")
  
```

### Electric v. ICE Cost per Mile

```{r Electric v ICE, warning=FALSE}
  
  ggplot() +
    geom_smooth(aes(elec_merged$year, elec_merged$centsPerMile, color="Electric")) +
    geom_smooth(aes(ice_merged$year,ice_merged$CentsPerMile, color="ICE")) +
    scale_color_manual("",
                       breaks = c("Electric", "ICE"),
                       values = c("blue", "brown")) +
    xlab("Year") +
    ylab("Cents per Mile") +
    ggtitle("Comparison of Electric and ICE Cars by Cost per Mile")
    
```


Now, the fleet of electric car options available is not as wide as those for ICE vehicles. We will limit out data set in two ways; one where we include only the vehicle classes where there is an EV option and another where we include only the vehicle classes for which there are more than 10 EV options.

```{r Subset of ICE Cars, warning=FALSE}
  
  # Create Unique List of VClasses for EVs
  elec_type <- elec_merged %>%
    select(VClass) %>%
    group_by(VClass) %>%
    summarize(Count = n())
  elec_type
  trim_elec_type <- elec_type %>%
    filter(Count > 10)
  trim_elec_type
  
  elec_merged_trim <- elec_merged %>%
    filter(VClass %in% trim_elec_type$VClass)
  
  # Trim the ICE data to only include comparable cars
  ice_comparable <- ice_merged %>%
    filter(VClass %in% elec_type$VClass)
  
  ice_comparable_trim <- ice_merged %>%
    filter(VClass %in% trim_elec_type$VClass)

  # Cost per Mile for Groups of ICE Vehicles
  ggplot() +
    geom_smooth(aes(ice_merged$year, ice_merged$CentsPerMile, color="All Classes")) +
    geom_smooth(aes(ice_comparable$year, ice_comparable$CentsPerMile, color="Classes with EV Option")) +
    geom_smooth(aes(ice_comparable_trim$year, ice_comparable_trim$CentsPerMile, color="Classes with > 10 EV Options")) +
  scale_color_manual("",
                     breaks = c("All Classes", "Classes with EV Option", "Classes with > 10 EV Options"),
                     values = c("brown", "blue", "black")) +
    ylab("Year") +
    xlab("Cents per Mile") +
    ggtitle("Cost per Mile for Groups of ICE Vehicles")
    
    
  # Comparison of Electric and ICE Cars by Cost per Mile (Assuming Same Vehicle Class)
  ggplot() +
    geom_smooth(aes(elec_merged_trim$year, elec_merged_trim$centsPerMile, color="Electric")) +
    geom_smooth(aes(ice_comparable_trim$year,ice_comparable_trim$CentsPerMile, color="ICE")) +
    scale_color_manual("",
                       breaks = c("Electric", "ICE"),
                       values = c("blue", "black")) +
    xlab("Year") +
    ylab("Cents per Mile") +
    ggtitle("Comparison of Electric and ICE Cars by Cost per Mile Comparing Same Vehicle Classes")
 
```

Even when we directly compare vehicle classes, electric vehicles are less costly to operate per mile driven, especially in the period of high gasoline prices as was seen through out the first decade of the century. 

## Emissions Comparison

Global warming is caused by increased greenhouse gases that allow heat from the sun to permeate to earth, but prevent that heat from escaping when reflected off the earth's surface. Atmospheric greenhouse gases have increased at alarming rates since the industrial revolution and the scientific community has concluded that we need to drastically cut back on burning fossil fuels; a process which releases carbon dioxide (CO2) a greehouse gas.

While it may seem obvious that an ICE vehicle emits more CO2 than an electric vehice, it is a bit more complicated. Since the electricity produced to "fuel" electric vehicles does not always come from renewable sources, there are indeed CO2 emissions related to operating an electric vehicle. In this section, we will compare the tailpipe emissions of CO2 per mile of comparable ICE vehicles and CO2 emissions related to producing the energy required to move an electric vehicle a mile.

### ICE Vehicle Tailpipe Emissions

There are emissions directly related to the operation of ICE vehicles in that when gasoline is burned to fuel the engine, CO2 is released from the tailpipe. Our data set from the U.S. Department of Energy provides information on tailpipe emissions in grams of CO2 per mile.

```{r ICE CO2 per Mile}
  
  # ICE CO2 per mile
  ice_comparable_trim %>%
    ggplot(aes(year, co2TailpipeGpm)) +
    geom_point() +
    geom_smooth(color="brown") +
    xlab("Year") +
    ylab("Grams per Mile") +
    ggtitle("CO2 per Mile for Comparable Class ICE Vehicles")
    
```

We can see in the chart above that comparable ICE vehicles have remained failry steady in their emissions per mile driven over the last thirty years. However, we have seem that in the last five years a slight improvement in tailpipe emissions.

### EV Tailpipe Emissions

Electric vehicles produce no CO2 at the tailpipe. EVs, in fact, do not even have tailpipes. However, CO2 is generally burned in order to create the electricity used to charge the battery in an EV. 

```{r EV CO2 per Mile}
  
  url <- "https://www.eia.gov/tools/faqs/faq.cfm?id=74&t=11"
  co2_kwh <- url %>% read_html() %>% html_node(xpath ='//*[@id="innerX"]/div/div[3]/div[1]/table') %>% html_table()
  
  co2_kwh <- co2_kwh %>%
    filter(Fuel != "Coal")
  co2_kwh$Fuel <- str_trim(as.character(co2_kwh$Fuel), "l")
  
```


# Final Analysis

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
summary(cars)
```

You can also embed plots, for example:

```{r, echo=FALSE}
plot(cars)

#http://www.fueleconomy.gov/feg/epadata/vehicles.csv.zip
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

##  
